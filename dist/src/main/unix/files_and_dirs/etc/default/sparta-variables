#!/bin/bash -e

######################### SPARTA VARIABLES #########################

# Application Name
export NAME=sparta

# Directory where the sparta binary distribution resides
export SPARTA_HOME=/opt/sds/$NAME

# sparta configuration directory
export SERVER_PROPERTIES=/etc/sds/$NAME

# Log directory
export LOG_DIR=/var/log/sds/$NAME
export LOG_FILE=$LOG_DIR/sparta.log
export LOG_CONFIG_FILE=$SERVER_PROPERTIES/log4j2.xml
export SPARK_LOG_CONFIG_FILE=$SERVER_PROPERTIES/log4j.properties
export JMX_PROMETHEUS_PATH=$SPARTA_HOME/jmx-prometheus

# Data directory
export DATA_DIR=/var/sds/$NAME

# Config file
export CONFIG_FILE=$SERVER_PROPERTIES/reference.conf

# Work directory
export WORK_DIR=/tmp/$NAME

HOST_IN_USE=$HOST
if [ -v CALICO_ENABLED ] && [ $CALICO_ENABLED == "true" ] && [ -v CALICO_NETWORK ] && [ ${#CALICO_NETWORK} != 0 ]; then
   DOCKER_HOST="hostname -f"
   if [[ "$(hostname -f)" =~ \. ]]; then
      DOCKER_HOST="$(hostname -f)"
   else
      DOCKER_HOST="$(hostname -i)"
   fi
  HOST_IN_USE=$DOCKER_HOST
fi

# JMX metrics
SPARTA_JMX_METRICS_PORT=5080
if [ -v PORT_5080 ] && [ ${#PORT_5080} != 0 ]; then
  SPARTA_JMX_METRICS_PORT=$PORT_5080
fi
if [ -v PORT_JMX_METRICS ] && [ ${#PORT_JMX_METRICS} != 0 ]; then
  SPARTA_JMX_METRICS_PORT=$PORT_JMX_METRICS
fi

# Heap Size
export SPARTA_HEAP_SIZE=-Xmx2048m
export SPARTA_HEAP_MINIMUM_SIZE=-Xms1024m
export SPARTA_JVM_SUMMARY="-XX:NativeMemoryTracking=summary"
export SPARTA_JVM_UNLOCK_EXPERIMENTAL_OPTIONS="-XX:+UnlockExperimentalVMOptions"
export SPARTA_JVM_USE_CGROUP_MEMORY_LIMIT="-XX:+UseCGroupMemoryLimitForHeap"
export SPARTA_JVM_GARBAGE_COLLECTOR="-XX:+UseConcMarkSweepGC"
export SPARTA_JVM_DISABLE_MEMORY_MAPPING="-Dsun.zip.disableMemoryMapping=true"
export SPARTA_JVM_JMX="-Djava.rmi.server.hostname=$HOST_IN_USE -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=$SPARTA_JMX_METRICS_PORT -Dcom.sun.management.jmxremote.rmi.port=5080 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"

# Prometheus metrics
SPARTA_METRICS_PORT=6080
if [ -v PORT_6080 ] && [ ${#PORT_6080} != 0 ]; then
  SPARTA_METRICS_PORT=$PORT_6080
fi
if [ -v PORT_METRICS ] && [ ${#PORT_METRICS} != 0 ]; then
  SPARTA_METRICS_PORT=$PORT_METRICS
fi


export SPARTA_PROMETHEUS_JAVA_AGENT="-javaagent:$JMX_PROMETHEUS_PATH/jmx_prometheus_javaagent-0.11.0.jar=$SPARTA_METRICS_PORT:$JMX_PROMETHEUS_PATH/config.yaml"

# Additional Java OPTS
export SPARTA_OPTS="$SPARTA_HEAP_MINIMUM_SIZE $SPARTA_HEAP_SIZE $SPARTA_JVM_UNLOCK_EXPERIMENTAL_OPTIONS $SPARTA_JVM_SUMMARY $SPARTA_JVM_USE_CGROUP_MEMORY_LIMIT $SPARTA_JVM_GARBAGE_COLLECTOR $SPARTA_JVM_DISABLE_MEMORY_MAPPING $SPARTA_JVM_EXTRA_OPTIONS $SPARTA_PROMETHEUS_JAVA_AGENT"
export DAEMON_OPTS="-Dconfig.file=$CONFIG_FILE -Djava.util.logging.config.file=file://$LOG_CONFIG_FILE"
#export SPARTA_CONFIG_JAAS_FILE=jaas.conf

if [ -v SPARTA_CONFIG_JAAS_FILE ] && [ ${#SPARTA_CONFIG_JAAS_FILE} != 0 ]; then
    export SPARTA_OPTS="$SPARTA_OPTS $SPARTA_CONFIG_JAAS_FILE"
fi

if [ -v JMX_METRICS_ENABLE ] && [ $JMX_METRICS_ENABLE == "true" ]; then
    export SPARTA_OPTS="$SPARTA_OPTS $SPARTA_JVM_JMX"
fi

export SPARTA_FILE_ENCODING=${SPARTA_FILE_ENCODING:--Dfile.encoding=UTF-8}
export SPARTA_OPTS="$SPARTA_OPTS $SPARTA_FILE_ENCODING"

# Maximum number of open files
export MAX_OPEN_FILES=65535

############################ SERVICE VARIABLES ############################
SCRIPTNAME=/etc/init.d/$NAME
# Run Sparta SSO as this user ID and group ID
USER=sparta
GROUP=stratio

# Define other required variables
RUN_DIR=/var/run/sds
PIDFILE=$RUN_DIR/$NAME.pid
LOCKDIR="/var/lock"
if [ -d $LOCKDIR/subsys ]; then # It's most likely a CentOS
	LOCKDIR=$LOCKDIR/subsys
fi
LOCKFILE=$LOCKDIR/$NAME
DAEMON=$SPARTA_HOME/bin/sparta.sh

