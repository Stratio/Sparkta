<!--
    © 2017 Stratio Big Data Inc., Sucursal en España. All rights reserved.
    This software – including all its source code – contains proprietary
    information of Stratio Big Data Inc., Sucursal en España and
    may not be revealed, sold, transferred, modified, distributed or
    otherwise made available, licensed or sublicensed to third parties;
    nor reverse engineered, disassembled or decompiled, without express
    written authorization from Stratio Big Data Inc., Sucursal en España.
-->

<div #wizardPipelinesModal qaTag="wizard-modal"></div>
<div id="wizard-embedded">
  <we-header
    [workflowData]="workflowData"
    [nodeName]="nodeName"
    [currentZoom]="svgPosition.k"
    [isDirtyEditor]="isDirtyEditor"
    [menuData]="menuData"
    [showDeleteButton]="selectedEdge || selectedNodes.length"
    [showEditButton]="selectedNodes.length"
    (selectedOption)="onSelectedOption($event)"
    (onZoomIn)="editor.changeZoom(svgPosition.k * 1.2)"
    (onZoomOut)="editor.changeZoom(svgPosition.k * 0.8)"
    (setZoom)="editor.changeZoom($event)"
    (onCenter)="editor.centerWorkflow()"
    (onEditButton)="weEditNode(selectedNodes[selectedNodes.length - 1])"
    (deleteSelection)="weDeleteSelection()"
    (onShowInfo)="isShowedInfo = !isShowedInfo"
    (onEditSettings)="weEditSettings()"
    (onSavePipelinesWorkflow)="weSavePipelinesWorkflow()">
  </we-header>

  <div class="we__editor">
    <graph-editor
      [(editorPosition)]="svgPosition"
      [creationMode]="creationMode"
      [disableEvents]="editedNode || settingsPipelinesWorkflow"
      [connectorPosition]="connectorInitPosition"
      (setEditorDirty)="weSetEditorDirty()"
      (finishSelection)="onCreateSelectionRect($event)"
      (createNode)="createNode($event)"
      (removeConnector)="removeConnector()">

      <svg:g wizard-edge
        *ngFor="let edge of getEdgesMap(); trackBy: trackByEdgeFn; let i=index;"
        [edge]="edge"
        [selectedEdge]="selectedEdge"
        [initPosition]="edge.origin.uiConfiguration.position"
        [endPosition]="edge.destination.uiConfiguration.position"
        (selectEdge)="weSelectEdge($event)">
      </svg:g>
      <svg:g draggable-element
        draggableGroupName="pipeline"
        [(position)]="nodeData.uiConfiguration.position"
        [multiDrag]="multiselection"
        [selected]="selectedNodes.indexOf(nodeData.name) > -1"
        (onDoubleClickEvent)="weEditNode(nodeData)"
        (setEditorDirty)="weSetEditorDirty()"
        (onClickEvent)="weSelectNode(nodeData)"
        *ngFor="let nodeData of nodes;">
        <svg:g wizard-node
          [data]="nodeData"
          [attr.node-name]="nodeData.name"
          [createdNew]="nodeData.createdNew"
          [serverStepValidation]="serverStepValidations && serverStepValidations[nodeData.name]"
          [selected]="selectedNodes.indexOf(nodeData.name) > -1"
          [drawingConnectionStatus]="drawingConnectionStatus"
          (onDrawConnector)="drawEdge($event)"
          (onFinishConnector)="onCreateEdge($event)">
        </svg:g>
      </svg:g>
    </graph-editor>

    <selected-entity *ngIf="creationMode.active"></selected-entity>

    <sidebar-config
      class="we__editor-sidebar"
      [nodeData]="editedNodeEditionMode"
      [isVisible]="isShowedInfo"
      topReference="we-header"
      (toggleSidebar)="isShowedInfo = !isShowedInfo">
    </sidebar-config>
  </div>

  <we-config-editor
    *ngIf="editedNode"
    [editedNode]="editedNode"
    [editedNodeEditionMode]="editedNodeEditionMode"
    [nodes]="nodes"
    [edges]="edges"
    [mlPipelineNode]="nodeDataEdited"
    (onCloseEdition)="weCloseEdition()"
    (onSaveEdition)="saveEdition($event)">
  </we-config-editor>

  <we-settings-editor
    [parentNodeData]="nodeDataEdited.editionType.data"
    [parentNode]="nodeDataEdited"
    *ngIf="settingsPipelinesWorkflow"
    (onCloseSettingsEdition)="closeSettingsEdition()"
    (onSaveSettingsEdition)="saveSettingsEdition($event)">
  </we-settings-editor>
</div>
